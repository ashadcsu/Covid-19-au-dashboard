
<html>

    <head>
        <style>
  
  .selectedL{
    opacity: .5;
  }
  .y_axis path{
    stroke: black;
  }
  .lg{
    margin-left: 20px;
  }
  .legend{
                margin-right: 5px;
            }
  #tooltip{
      border: solid 2px black;
      padding: 5px;
      position: absolute;
      display: none;
      background-color: whitesmoke;
  }
            body {
                font-family: Helvetica, Arial, sans-serif;
                background-color: #DCDCDC;
            }
            h1 {
                background-color: #2a5599;
                color: white;
                padding: 5px;
                margin-top: -8px;
                margin-left: -8px;
                margin-right: -8px;
                margin-bottom: 0px;
            }
            svg {
                border: solid 1px black;
            }
  
            .result{
              padding: 5px;
              margin-bottom: 10px;
              margin-left: 15px;
  
              
            }
            
            .info{
                display: flex;
                margin-top: 30px;
                margin-bottom: 30px;
            }
             div.tc{
    width: 100px;
    text-align: center;
    color:#808080;
    width: 100px;
    padding: 0 1em;
    line-height: 1.2;
    font-size: .9em;
    vertical-align: top;
    border-right:1px dotted gray;
  }
  div.tc1{
    width: 100px;
    text-align: center;
    color:#808080;
    width: 100px;
    padding: 0 1em;
    line-height: 1.2;
    font-size: .9em;
    vertical-align: top;
    border-right:1px dotted gray;
  }
  div.tc2{
    width: 100px;
    text-align: center;
    color:#808080;
    width: 100px;
    padding: 0 1em;
    line-height: 1.2;
    font-size: .9em;
    vertical-align: top;
    border-right:1px dotted gray;
  }
  div.tc3{
    width: 100px;
    text-align: center;
    color:#808080;
    width: 100px;
    padding: 0 1em;
    line-height: 1.2;
    font-size: .9em;
    vertical-align: top;
    border-right:1px dotted gray;
  }
  div.res{
    height: 40px;
    width: 350px;
    text-align: left;
    color:grey;
    padding: 0 1em;
    margin-left: 140px;
    line-height: 1.2;
    vertical-align: top;
    font-size: 1em;
    
  }
  
            .mainView {
                display: flex;
                flex-direction: row;
            }
    
            #filter_countries{
    width:15%;
    padding:10px;
    position: absolute;
    right: 0%;
    
  }
  
  #Map{
    background:#DCDCDC;
    margin-left: 0px;
    margin-right: 8px;
  }
  
  #countries-list{
  
    right: 0%;
    overflow: hidden;
    overflow-y:scroll;
    margin-top: 40px;
    padding:5px;
    position: absolute;
    height:450px; width:198px;
    background-color: transparent;
    color: black;
    fill-opacity: .1;
    
  }
  #countries-list li{
    
    position: relative; 
    list-style:none;
    padding:0px;
    margin:5px;
    border: 1px solid #e4e4e4;
   
  }
  #s{
    border: none;
  }
  circle {
    fill-opacity: .55;
    stroke-width: .5;
  }
  label{
    padding: 5px;
    color:#808080;
    font-size: 1.2em;
    
  }
  
  .lasso path {
    stroke: rgb(80,80,80);
    stroke-width:2px;
  }
  
  .lasso .drawn {
    fill-opacity:.05 ;
  }
  
  .lasso .loop_close {
    fill:none;
    stroke-dasharray: 4,4;
  }
  
  .lasso .origin {
    fill:#3399FF;
    fill-opacity:.5;
  }
  
  .not_possible {
    fill:#415679;
    
  }
  
  .possible {
    fill: violet;
  }
  
  .selected {
    fill : yellow;
    fill-opacity: 1;
    stroke: black;
    stroke-width: 1.5;
  }
  
  .selected1 {
    fill : purple;
    fill-opacity: 1;
    stroke: black;
    stroke-width: 1.5;
  }
  
  
  .isselected {
    fill: red;
  }
                                                                            /* previousl 55 */
            div.tooltip {position: absolute; text-align: left; width: 205px; height: 95px; padding: 15px;font: 14px calibri; background: whitesmoke; color:black; border: 2px; border-radius: 8px; pointer-events: none;}
  div.tooltip1{
  
    position: absolute; text-align: left; width: 200px; height: 95px; padding: 15px;font: 14px calibri; background:whitesmoke; color: black; border: 2px; border-radius: 8px; pointer-events: none;
   
  }
  /* 
  .bar {
          fill: steelblue;
          clip-path: url(#clip);
        } */
  #Bar{
    width: 390px;
  }
        #BarChart{
          margin-top: 60px;
          margin-left: -60px;
          margin-right: 0px;
          margin-bottom: 0px;
          background-color: #DCDCDC;
          
        }
  
        #container{
          background-color: #DCDCDC;
        }
          
        .subBar { 
          fill: gray;
          opacity: 0.5;
        }
        
        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }
        
        .brush .extent {
          stroke: #fff;
          fill: steelblue;
          fill-opacity: .25;
          shape-rendering: crispEdges;
        }
        
          rect.mover {
                    stroke: black;
                    stroke-opacity: .5;
                    fill:white;
                    fill-opacity: .8;
                    overflow-y: scroll;
                }
      #slide{
        width: 400px;
  
      }
      #slider-range{
           width: 380px;
           margin: 15px;
      }
  
      /* The Modal (background) */
  .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  }
  
  /* Modal Content */
  .modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 40%;
  }
  
  /* The Close Button */
  .close {
    color: #aaaaaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  
  .close:hover,
  .close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
  }
  #stack {
    margin-top: 60px;
    margin-left: -60px;
    margin-right: 0px;
    margin-bottom: 0px;
}
  
      
  
        </style>
        <script src="./d3-lasso.min.js"></script>
        <script src="d3.js"></script>
        <title>COVID-19 Dashboard</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <!-- <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
  
    </head>
    
    <body>
        <h1>COVID-19 in Australia</h1>
      
        <div class="info">
                <div class="tc" ></div>
               <div class="tc1"></div>
                <div class="tc2"></div>
                <div class="tc3"></div> 
                <div style="border-right:1px dotted gray; padding: 0 1em;">
                    <form >
                        <label>Choose Case:</label>
                      <select id="options" name="cars" onchange="ddl()">
                        <option value="Confirmed Cases">Confirmed Cases</option>
                        <option value="Death Cases">Death Cases</option>
                        <option value="Recovered Cases">Recovered Cases</option>
                        <option value="Active Cases">Active Cases</option>
                        <!-- <option value="New Cases">New Cases</option> -->
                      </select>
                    </form>
                  </div>
                  <div style="border-right:1px dotted gray; padding: 0 1em;">
                    <form >
                        <label>Select State/Territory:</label>
                      <select id="countries" class="chosen" name="countries" onchange="myScript()">
                        
                      </select>
                    </form>
                  </div>
                  <div>
                      <label for="amount">Date range:</label>
                      <input type="text" id="amount" style="border: 0; color: blue; font-weight: bold;" size="30"/>     
                    <div id="slider-range"></div>
                  </div>
        </div>
        <div class="mainView">
            <div id="bar">
                <svg id="BarChart"  style="transform: rotate(90deg)" >
                    
                </svg>
            </div>
            <div>
                <svg id="Map">
                    <g id="G"></g>
                </svg>
            </div>
            <div>
                <div> 
                  <svg id="container" height="500px" width="640px"> 
                    <g id="body2" style="transform: translate(60px,10px);margin-top:50px ;"></g>
                </svg>
                </div>
                <div id="tooltip"></div>
                <div style="transform: translate(190px,-250px);margin-top:50px ;"></div>
              
  
  
            </div>
            
            
    
        </div>
        <div id="stack" style="transform: rotate(90deg)" >

        </div>
        
        
    
    </body>
    <script>
        let store={}
        let slidedata;
        store.done=[];
        store.afterlasso=[];
        store.currentcommand=null;
        store.currentselectedcountries=[];
        store.mapafterlinelasso={}
            let x=0
            let y=0
            let k=1
            let deg=0
            let svg=d3.select("#Map")
            let currentvis="";
            div = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0)
        
        
          function loadData() {
            return Promise.all([
            d3.csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv', (d, rows, cols) => { 
          
          const dates = cols.slice(4, cols.length);
          const data = [];
            
          dates.forEach((dd, i)=> {
            const match = d['Country/Region'];
            const country = d['Country/Region'];
            const short = d['Country/Region'];
            const region = d['Province/State'];
            const iso = (match !== undefined)?match.iso:'';
            const lat = d['Lat'];
            const lon = d['Long'];
            const date = dd;
            const confirmed = +d[dd];
            const pivot = {
              country: country, short: short, region: region, lat: lat, lon: lon, date: date, confirmed: confirmed, iso: iso
            }
            
            data.push(pivot)
            
          })
          //console.log(data)
        
          return data
         
        }),
                d3.json("au_states.geojson"),
                d3.csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv', (d, rows, cols) => { 
          
          const dates = cols.slice(4, cols.length);
          const data = [];
          
          dates.forEach(dd=> {
            const match = d['Country/Region']
            const country = d['Country/Region'];
            const region = d['Province/State'];
            const iso = (match !== undefined)?match.iso:'';
            const lat = d['Lat'];
            const lon = d['Long'];
            const date = dd;
            const deaths = +d[dd];
            const pivot = {
              country: country, region: region, lat: lat, lon: lon, date: date, deaths: deaths, iso: iso
            }
            
            data.push(pivot)
            
          })
          
          return data
          
        }),d3.csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv', (d, rows, cols) => { 
          
          const dates = cols.slice(4, cols.length);
          const data = [];
          
          dates.forEach(dd=> {
            const match = d['Country/Region']
            const country = d['Country/Region'];
            const region = d['Province/State'];
            const iso = (match !== undefined)?match.iso:'';
            const lat = d['Lat'];
            const lon = d['Long'];
            const date = dd;
            const recovered = +d[dd];
            const pivot = {
              country: country, region: region, lat: lat, lon: lon, date: date, recovered: recovered, iso: iso
            }
            
            data.push(pivot)
            
          })
          
          return data
          
        })
            ]).then(datasets => {
                
                store.coronadat=datasets[0];
                store.geoJSON = datasets[1];
                store.death=datasets[2];
                store.recovered=datasets[3];
                return store;
            })
        }
        
          function showData() { 
            currentvis="confirm";
         groupbytime()
          drawMap(prep(store.geoJSON))
          stackprocess()
          slidedata = store.sumdate;
     
          drawline(store.sumdate)
        // groupbyCountryDeath(store.death)
            //drawCircles(store.done,"blue")
            drawbar(store.done)
           generate_region_list(store.coronadat)
          total_case_print(store.done)
          total_case_print1(store.done)
          total_case_print2(store.done)
          total_case_print3(store.done)
          drawstackbar(store.done)
          
          
        
        }
        
          
            function getMapConfig(){
          let width = 480;
          let height = 500;
          let container=d3.select("#G")
          let zoom = d3.zoom()
               .scaleExtent([1, 40])
               .translateExtent([[0,0], [width, height]])
               .extent([[0, 0], [width, height]])
            .on("zoom",function(){
                zoomed(container)
            })
          
        
          let containe = d3.select("#Map")
                          .attr("height",height)
                          .attr("width",width)
                          .call(zoom)
        
          
          return {width, height, container}
        }
        
        
        function zoomed(container)
          {
            x=d3.event.transform.x
            y=d3.event.transform.y
            k=d3.event.transform.k
         
        container.attr(
              "transform","translate(" + [d3.event.transform.x, d3.event.transform.y] + ")scale(" + d3.event.transform.k + ")rotate("+deg+",300,150)")
             
          }
        
        function getMapProjection(config) {
          let {width, height} = config;
          let projection = d3.geoMercator()
          projection.scale(509)
                  .translate([width / 2-1180, height / 2 - 250]);
                    
          store.mapProjection = projection;
          return projection;
        }
        
        function drawBaseMap(container, countries, projection){
          let path =d3.geoPath()
                     .projection(projection)
        mc=0
        for(i of countries)
        {
          if(currentvis=="confirm"){
          if(mc<i.confirmed){
              mc=i.confirmed
          }}
          else if(currentvis=="death"){
          if(mc<i.deaths){
              mc=i.deaths
          }}
          else if(currentvis=="recovered"){
          if(mc<i.recovered){
              mc=i.recovered
          }}
          else if(currentvis=="active")
          {
            if(mc<i.active){
              mc=i.active
          }

          }
        }
        //console.log(mc)
        clr=[]
        if(currentvis=="confirm"){
          clr=["#deebf7","#2171b5"];
          }
          else if(currentvis=="death"){
            clr=["#fee0d2","#ef3b2c"];
            }
          else if(currentvis=="recovered"){
            clr=["#e5f5e0","#238b45"];
            }
          else if(currentvis=="active")
          {
            clr=["#fff5eb","#f16913"];
          }
        
        var color_scale =d3.scaleLinear().domain([0,mc]).range(clr);
        
          container.selectAll("path").data(countries)
              .enter().append("path")
              .attr("d",d=>path(d) )
              .attr("fill",function(d)
              {
                  if(currentvis=="confirm")return color_scale(d.confirmed);
                  else if(currentvis=="death")return color_scale(d.deaths);
                  else if(currentvis=="recovered")return color_scale(d.recovered);
                  else if(currentvis=="active")return color_scale(d.active);
              })
            .attr("stroke", "gray")
            .attr("stroke-width", .5)
            .on("mousemove", function(d) {
                 d3.select(this)
                 .attr("stroke","#000f1a")
                 .attr("stroke-width", "2px")
                 div
                .transition()
                .duration(200)
                .style("opacity", .9);
              div
                .html(
                  "<b>Region: </b>" +
                    d.properties.STATE_NAME +
                    "</br><b>CONFIRMED CASES: </b>" +
                  d.confirmed +
                  "</br><b>DEATH CASES: </b>" +
                  d.deaths +
                  "</br><b>RECOVERED CASES: </b>" +
                  d.recovered +
                  "</br><b>ACTIVE CASES: </b>" +
                  d.active +
                    "</br>AS OF " +
                  store.date
                )
                .attr("class","tooltip1")
                .style("left", 650 + "px")
                .style("top", 175 + "px");
                 
                })
              .on("mouseleave",function(d){
                d3.select(this).attr("stroke","gray").attr("stroke-width",".5px")

                div
                .attr("class","tooltip1")
                .transition()
                .duration(500)
                .style("opacity", 0);
              })
              .on('click',function(d)
              {
                //console.log(d)
                l=d3.select('#G').selectAll('path')._groups[0]
                ln=d3.select('#G').selectAll('path')._groups[0].length
                for(let i=0;i<ln-3;i++)
                {
                  if(l[i].__data__.properties.STATE_NAME==d.properties.STATE_NAME)
                  {
                    d3.select(l[i]).classed('selected',true);
                  }
                  else{
                    d3.select(l[i]).classed('selected',false);

                  }
                }
                let c=[]
                c.push(d)
                 myScript2(d.properties.STATE_NAME);
                 total_case_print(c)
                 total_case_print1(c)
                 total_case_print2(c)
                 total_case_print3(c)
                 aftermaplasso(c)

              })
  
  
              var w = 300, h = 50;
  
      d3.select("#s").remove()
  
      var key = d3.select("#Map")
        .append("svg")
        .attr("id","s")
        .attr("width", w)
        .attr("height", h);
  
      var legend = key.append("defs")
        .append("svg:linearGradient")
        .attr("id", "gradient")
        .attr("x1", "0%")
        .attr("y1", "100%")                             
        .attr("x2", "100%")
        .attr("y2", "100%")
        .attr("spreadMethod", "pad");
  
      
  
      legend.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", function(d)
        {
          if(currentvis=="confirm")return "#deebf7";
          else if(currentvis=="recovered")return "#f7fcf5";
          else if(currentvis=="death") return "#fee0d2";
          else return "#fff5eb";
        }
        )
        .attr("stop-opacity", 1);
  
      legend.append("stop")
        .attr("offset", "20%")
        .attr("stop-color", function(d)
        {
          if(currentvis=="confirm")return "#c6dbef";
          else if(currentvis=="recovered")return "#c7e9c0";
          else if (currentvis=="death") return "#fcbba1";
          else return "#fee6ce";
        }

        )
        .attr("stop-opacity", 1);
  
      legend.append("stop")
        .attr("offset", "40%")
        .attr("stop-color",
        function(d)
        {
          if(currentvis=="confirm")return "#9ecae1";
          else if(currentvis=="recovered")return "#a1d99b";
          else if(currentvis=="death") return "#fc9272";
          else return "#fdd0a2";
        }
         )
        .attr("stop-opacity", 1);
  
      legend.append("stop")
        .attr("offset", "60%")
        .attr("stop-color", function(d)
        {
          if(currentvis=="confirm")return "#6baed6";
          else if(currentvis=="recovered")return "#74c476";
          else if(currentvis=="death") return "#fb6a4a";
          else return "#fdae6b";
        }
        )
        .attr("stop-opacity", 1);
  
        legend.append("stop")
        .attr("offset", "80%")
        .attr("stop-color",function(d)
        {
          if(currentvis=="confirm")return "#4292c6";
          else if(currentvis=="recovered")return "#41ab5d";
          else if(currentvis=="death")return "#ef3b2c";
          else return "#fd8d3c";
        }
         )
        .attr("stop-opacity", 1);
  
        legend.append("stop")
        .attr("offset", "100%")
        .attr("stop-color",function(d)
        {
          if(currentvis=="confirm")return "#2171b5";
          else if(currentvis=="recovered")return '#238b45';
          else if(currentvis=="death") return "#ef3b2c";
          else return "#f16913";
        }
         )
        .attr("stop-opacity", 1);
  
        
  
      key.append("rect")
        .attr("width", w)
        .attr("height", h - 30)
        .style("fill", "url(#gradient)")
        .attr("transform", "translate(20,10)");
  
      a=[]
      if(currentvis=="confirm")a= [Math.round((mc*.9)/1000)+"k",Math.round((mc*.09)/1000)+"k",Math.round((mc*.01)/1000)+"k",Math.round((mc*.004)/1000)+"k",Math.round((mc*.001)/1000)+"k",Math.round((mc*.0009)/1000)+"k" , 0];
      else if(currentvis=="recovered")a= [Math.round((mc*.9)/1000)+"k",Math.round((mc*.09)/1000)+"k",Math.round((mc*.01)/1000)+"k",Math.round((mc*.004)),Math.round(mc*.001),Math.round((mc*.0009)) , 0]
      var y = d3.scaleBand()
        .range([300, 0])
        .domain(a
          );
  
     d3.select("#a").remove()
     d3.select("#b").remove()     
  
      d3.select("#Map").append("g")
        .attr("id","a")
        .attr("class", "y_axis")
        .attr("color","black")
        .attr("transform", "translate(15,15)")
        .append("text")
        .attr("y", 0)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text(0);
  
        d3.select("#Map").append("g")
        .attr("id","b")
        .attr("class", "y_axis")
        .attr("color","black")
        .attr("transform", "translate(305,15)")
        .append("text")
        .attr("y", 0)
        .attr("dy", ".71em")
        .text(function(d)
        {
          if (mc.toString().length >6)return (mc/1000000).toFixed(2) + "M" ;
          else if(mc.toString().length>=3) return (mc/1000).toFixed(2) +"k";
          else return mc
        });
  
  
  
        var lasso_start = function() {
                    lasso.items() // reset size
                        .classed("not_possible",true)
                        .classed("selected",false)
                        .classed("selected1",false);
                };
        
                var lasso_draw = function() {
                
                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible",false)
                        .classed("possible",true)
                        .classed("selected1",false);
            
                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible",true)
                        .classed("possible",false)
                        .classed("selected1",false);
                };
        
                var lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible",false)
                        .classed("possible",false)
                        .classed("isselected",false);
        
                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected",true);
  
  
                        if(lasso.selectedItems()._groups[0].length==0)
                    {
                      d3.select(".res").text("Showing Results for All Countries");
                    }
                    if(lasso.selectedItems()._groups[0].length>0)
                    {
                    d3.select(".res").text("Showing Results for selected Countries");
                    }
                    
                    let d=[];
                    let cn=[];
                    let dn=[];
                    for(i of lasso.selectedItems()._groups[0]){
                if(i.__data__!=null)
                {
                  d.push(i.__data__)
                  cn.push(i.__data__.country)
                  dn.push(i.__data__.properties.STATE_NAME)
                }
        }
        store.currentselectedcountries=cn;
        store.afterlasso=d
        total_case_print(d)
        total_case_print1(d)
        total_case_print2(d)
        total_case_print3(d)
  
        l= d3.selectAll("rect")._groups[0]
        ln=d3.selectAll("rect")._groups[0].length
       for(i=0;i<ln-116;i++)
       {
         if(dn.includes(l[i].__data__.region))
         {
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",true)
         }
         else{
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",false)
         }
       }
  // console.log()
      //  if(d.length>0)aftermaplasso(d);
        if(d.length==0) drawline(store.sumdate)
  
      //  if(store.currentcommand!=null)
      //    {
      //      console.log("asci")
      //      document.getElementById('command').value=store.currentcommand;
      //      command();
      //    }
                };
                
                var lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .targetArea(container)
                    .on("start",lasso_start)
                    .on("draw",lasso_draw)
                    .on("end",lasso_end);
        
                container.call(lasso)
                lasso.items(container.selectAll('path'))
  
  
        
    
             
             
              
              
        }
        
        function drawMap(geoJeon) {
            let config = getMapConfig();
            let projection = getMapProjection(config)
            drawBaseMap(config.container, geoJeon.features, projection)
        }
        
        let myData;
        function groupbyCountry(data) {
          //console.log(data)
            confirmedLatest = data.map(d => d[d.length-1]).sort((a,b) => b.confirmed - a.confirmed);
            myData = confirmedLatest;
            
            let result = confirmedLatest.reduce((result, d) => {
                //The || sign in the line below means that in case the first option is anything that Javascript consider false (this insclude undefined, null and 0), the second option will be used. Here if result[d.DestAirportID] is false, it means that this is the first time we are seeing the airport, so we will create a new one (second part after ||)
                
                let grpbycounty = result[d.country] || {
                    country: d.country,
                    short: d.short,
                    lat: d.lat,
                    lon: d.lon,
                    iso: d.iso,
                    date: d.date,
                    confirmed: 0
                }
                grpbycounty.confirmed += d.confirmed
                result[d.country] = grpbycounty
        
                return result
            }, {})
            result = Object.keys(result).map(key => result[key])
            result= result.sort((a,b) => b.confirmed - a.confirmed);
            
            return result;
        }
        
        function groupbyCountryDeath(data)
        {
          confirmedLatestdeath = data.map(d => d[d.length-1]).sort((a,b) => b.deaths - a.deaths);
            myData = confirmedLatestdeath;
            //console.log(myData);
            let result = confirmedLatestdeath.reduce((result, d) => {
                //The || sign in the line below means that in case the first option is anything that Javascript consider false (this insclude undefined, null and 0), the second option will be used. Here if result[d.DestAirportID] is false, it means that this is the first time we are seeing the airport, so we will create a new one (second part after ||)
                
                let grpbycounty = result[d.country] || {
                    country: d.country,
                    lat: d.lat,
                    lon: d.lon,
                    iso: d.iso,
                    date: d.date,
                    deaths: 0
                }
                grpbycounty.deaths += d.deaths
                result[d.country] = grpbycounty
        
                return result
            }, {})
            result = Object.keys(result).map(key => result[key])
            result= result.sort((a,b) => b.deaths - a.deaths);
            
            return result;
        }
        
        
        function groupbyCountryRecovered(data)
        {
          confirmedLatestrecovered = data.map(d => d[d.length-1]).sort((a,b) => b.recovered - a.recovered);
            myData = confirmedLatestrecovered;
            //console.log(myData);
            let result = confirmedLatestrecovered.reduce((result, d) => {
                //The || sign in the line below means that in case the first option is anything that Javascript consider false (this insclude undefined, null and 0), the second option will be used. Here if result[d.DestAirportID] is false, it means that this is the first time we are seeing the airport, so we will create a new one (second part after ||)
                
                let grpbycounty = result[d.country] || {
                    country: d.country,
                    lat: d.lat,
                    lon: d.lon,
                    iso: d.iso,
                    date: d.date,
                    recovered: 0
                }
                grpbycounty.recovered += d.recovered
                result[d.country] = grpbycounty
        
                return result
            }, {})
            result = Object.keys(result).map(key => result[key])
            result= result.sort((a,b) => b.recovered - a.recovered);
            
            return result;
        }
        
        //group by time start
        function groupbytime()
        {
          //console.log("hello")
          var byRegion = d3.nest()
            .key(function(d) {
              return d.region;
            })
            .entries(store.coronadat.slice(8,16).flat());
        
         
  
  //////death///////
          var byRegiondeath = d3.nest()
            .key(function(d) {
              return d.region;
            })
            .entries(store.death.slice(8,16).flat());
           
  
  
  /////////recovered////////
          var byCountryrecoverd = d3.nest()
            .key(function(d) {
              return d.region;
            })
            .entries(store.recovered.slice(8,16).flat());
        
  
        
        for(i=0;i<byRegion.length;i++)
        {
          for(j=0;j<byRegion[i].values.length;j++)
          {
            byRegion[i].values[j].deaths=byRegiondeath[i].values[j].deaths;
            // byCountry[i].values[j].recovered=byCountryrecoverd[i].values[j].recovered;
             byRegion[i].values[j].active=byRegion[i].values[j].confirmed - byRegiondeath[i].values[j].deaths;
            if (j==0){
            byRegion[i].values[j].new=0
            byRegion[i].values[j].new_death=0
            byRegion[i].values[j].new_recovered=0}
            else{
              byRegion[i].values[j].new=byRegion[i].values[j].confirmed - byRegion[i].values[j-1].confirmed;
              byRegion[i].values[j].new_death=byRegion[i].values[j].deaths - byRegion[i].values[j-1].deaths;
            }
          }
        }
        for (i of byRegion)
        {
           for(j of byCountryrecoverd)
           {
             
                if(i.key==j.key)
                {
                  for( k=0;k<j.values.length;k++)
                  {
                    i.values[k].recovered=j.values[k].recovered;
                    i.values[k].active-=j.values[k].recovered;
                    
                  }
                  break;
                }
           }
           
        }
        for(i=0;i<byRegion.length;i++)
        {
          for(j=0;j<byRegion[i].values.length;j++)
          {
            
            if (j==0){
            byRegion[i].values[j].new_recovered=0;
            byRegion[i].values[j].new_active=0;
          }
            else{
              byRegion[i].values[j].new_recovered=byRegion[i].values[j].recovered  - byRegion[i].values[j-1].recovered;
              byRegion[i].values[j].new_active=byRegion[i].values[j].active - byRegion[i].values[j-1].active;
            }
          }
        }
        // console.log(byCountryrecoverd)
           store.time=byRegion;

           

           
  
        df=byRegion[0].values.length
        k=[]
        
        
        for(i=0;i<df;i++)
        {
          let c=0;
          let d=0;
          let r=0;
          let nw=0;
          let ac=0;
          let ndc=0;
          let nrc=0;
          let nac=0;
          dt=''
          for(j=0;j<store.time.length;j++)
          {
            dt=store.time[j].values[i].date;
            c+=store.time[j].values[i].confirmed;
            d+=store.time[j].values[i].deaths;
            r+=store.time[j].values[i].recovered;
            nw+=store.time[j].values[i].new;
            ac+=store.time[j].values[i].active;
            ndc+=store.time[j].values[i].new_death;
            nrc+=store.time[j].values[i].new_recovered;
            nac+=store.time[j].values[i].new_active;
          }
          k.push({
            date:dt,
            confirmed: c,
            deaths: d,
            recovered: r,
            new_case: nw,
            active: ac,
            new_death_case: ndc,
            new_recovered_case: nrc,
            new_active_case: nac
          })
            store.sumdate=k
  
         
        }    
          
        }
  //// end group by time
        function prep(){

           let ln=store.time[0].values.length
           let d=[]
           for(i of store.time)
           {
               d.push(i.values[ln-1])
           }
           console.log(d)
        

           let a=d;
  
            for(i=0;i<a.length;i++)
            {
                
                b=a[i].region;
                
                for (j of store.geoJSON.features)
                {
                    if(j.properties.STATE_NAME==b)
                    {
                        j.confirmed=a[i].confirmed;
                        j.deaths=a[i].deaths;
                        j.recovered=a[i].recovered;
                        j.country=a[i].country;
                        j.active=a[i].active;
                        break;
                    }
                    else {
                      if(!('country' in j))
                      {
                        j.country=""
                      }
                    }
                    
                }
            }
            for (i of store.geoJSON.features)
            {
                if(!('confirmed' in i)){
                    i.confirmed=0;
                    i.deaths=0
                    i.recovered=0
                    i.active=0
                }
            }
  
            store.done=a
            store.date=a[0].date;
            store.mapafterlinelasso=store.geoJSON
            return store.geoJSON;
            
  
  
        }
  
        function stackprocess()
        {
          if(currentvis=="confirm")
          {
            a=store.done.sort((a,b) => b.confirmed - a.confirmed);
          }
          else if(currentvis=="death")
          {
            a=store.done.sort((a,b) => b.deaths - a.deaths);
          }
          else{
            a=store.done.sort((a,b) => b.recovered - a.recovered);
          }
          let l=[]
            for(i of a)
            {
              l.push({
                region: i.region,
                cases: "Confirmed",
                number: i.confirmed
              })
              l.push({
                region: i.region,
                cases: "Active",
                number: (i.confirmed - (i.recovered + i.deaths))
              })
              l.push({
                region: i.region,
                cases: "Recovered",
                number: i.recovered
              })
              l.push({
                region: i.region,
                cases: "Death",
                number: i.deaths
              })
            }
            store.stackbar=l
            return l
        }
        
        function drawCircles(countrycircle,clr) {
          let config = getMapConfig(); 
          let projection = getMapProjection(config)
          let container = config.container; 
          container.innerHTML=""
          radius = d3.scaleSqrt([0,d3.max(countrycircle, d=> d.confirmed)], [.5, config.width/40])
          let circles = container.selectAll("circle")
            .data(countrycircle)
            .enter()               //confiremedlates earlier//
          .append("circle")
          .attr("class", "confirmed")
            .attr("fill", clr)
            .attr("fill-opacity", ".15")
            .join("circle")
            .attr("transform", d => `translate(${projection([d.lon,d.lat])[0]},${projection([d.lon,d.lat])[1]})`)
            .attr("r", 0)//radius funtion previosly
            .on("mouseenter", function(d) {
                 // d3.select(this).attr("fill", "#229a5b")
                 div
                .transition()
                .duration(200)
                .style("opacity", .9);
              div
                .html(
                  "<b>COUNTRY: </b>" +
                    d.country +
                    "</br><b>CONFIRMED CASES: </b>" +
                  d.confirmed +
                  "</br><b>Death CASES: </b>" +
                  d.deaths +
                  "</br><b>Recovered CASES: </b>" +
                  d.recovered +
                    "</br>AS OF " +
                  d.date
                )
                .attr("class","tooltip")
                .style("left", d3.event.pageX + "px")
                .style("top", d3.event.pageY - 28 + "px");
                 
                })
              .on("mouseleave",function(){
                div
                .attr("class","tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
              })
              // .on("click",function(d){
              //   d3.select(this).transition().duration(1000).attr("r",radius(d.confirmed)+10).attr("fill","red").transition().duration(1000).attr("r",radius(d.confirmed))
              //   .transition().duration(1000).attr("r",radius(d.confirmed)+10).transition().duration(1000).attr("r",radius(d.confirmed))
              //   .transition().duration(1000).attr("r",radius(d.confirmed)+10).transition().duration(1000).attr("r",radius(d.confirmed))
              //   .transition().duration(1000).attr("r",radius(d.confirmed)+10).transition().duration(1000).attr("r",radius(d.confirmed))
              //   .transition().duration(1000).attr("r",radius(d.confirmed)+10).transition().duration(1000).attr("r",radius(d.confirmed)).transition().duration(1000).attr("fill","maroon")
              
              // })
        
        
        
              var lasso_start = function() {
                    lasso.items() // reset size
                        .classed("not_possible",true)
                        .classed("selected",false)
                        .classed("selected1",false);
                };
        
                var lasso_draw = function() {
                
                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible",false)
                        .classed("possible",true)
                        .classed("selected1",false);
            
                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible",true)
                        .classed("possible",false)
                        .classed("selected1",false);
                };
        
                var lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible",false)
                        .classed("possible",false)
                        .classed("isselected",false);
        
                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected",true);
  
  
                        if(lasso.selectedItems()._groups[0].length==0)
                    {
                      d3.select(".res").text("Showing Results for All Countries");
                    }
                    if(lasso.selectedItems()._groups[0].length>0)
                    {
                    d3.select(".res").text("Showing Results for selected Countries");
                    }
                    
                    let d=[];
                    let cn=[];
                    for(i of lasso.selectedItems()._groups[0]){
                if(i.__data__!=null)
                {
                  d.push(i.__data__)
                  cn.push(i.__data__.country)
                }
        }
        store.currentselectedcountries=cn;
        store.afterlasso=d
        total_case_print(d)
        total_case_print1(d)
        total_case_print2(d)
  
        l= d3.selectAll("rect")._groups[0]
       for(i=0;i<205;i++)
       {
         if(cn.includes(l[i].__data__.country))
         {
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",true)
         }
         else{
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",false)
         }
       }
  console.log()
       if(d.length>0)aftermaplasso(d);
       else drawline(store.sumdate)
  
       if(store.currentcommand!=null)
         {
           console.log("asci")
           document.getElementById('command').value=store.currentcommand;
           command();
         }
                };
                
                var lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .targetArea(container)
                    .on("start",lasso_start)
                    .on("draw",lasso_draw)
                    .on("end",lasso_end);
        
                container.call(lasso)
                lasso.items(container.selectAll('path'))
  
  //                 container.selectAll("text")
  //         .data(countrycircle)
  //         .enter().append("svg:text")
  //     .text(function(d){
  //         return d.country;
  //     }).attr("transform", d => `translate(${projection([d.lon,d.lat])[0]},${projection([d.lon,d.lat])[1]})`)
  // .attr("text-anchor","middle")
  //     .attr('font-size','2pt');
        
        
        }
        
        
        
        function drawCirclesdeath(deathcircle,clr) {
          let config = getMapConfig(); 
          let projection = getMapProjection(config)
          let container = config.container; 
          container.innerHTML=""
          radius = d3.scaleSqrt([0,d3.max(deathcircle, d=> d.deaths)], [.5, config.width/40])
          let circles = container.selectAll("circle")
            .data(deathcircle)
            .enter()               //confiremedlates earlier//
          .append("circle")
          .attr("class", "confirmed")
            .attr("fill", clr)
            .attr("fill-opacity", ".15")
            .join("circle")
            .attr("transform", d => `translate(${projection([d.lon,d.lat])[0]},${projection([d.lon,d.lat])[1]})`)
            .attr("r", 0)//radius funtion previosly
            // .on("mouseenter", function(d) {
            //      // d3.select(this).attr("fill", "#229a5b")
            //      div
            //     .transition()
            //     .duration(200)
            //     .style("opacity", .9);
            //   div
            //   .html(
            //       "<b>COUNTRY: </b>" +
            //         d.country +
            //         "</br><b>CONFIRMED CASES: </b>" +
            //       d.confirmed +
            //       "</br><b>Death CASES: </b>" +
            //       d.deaths +
            //       "</br><b>Recovered CASES: </b>" +
            //       d.recovered +
            //         "</br>AS OF " +
            //       d.date
            //     )
            //     .attr("class","tooltip")
            //     .style("left", d3.event.pageX + "px")
            //     .style("top", d3.event.pageY - 28 + "px");
                 
            //     })
            //   .on("mouseleave",function(){
            //     div
            //     .attr("class","tooltip")
            //     .transition()
            //     .duration(500)
            //     .style("opacity", 0);
            //   })
            //   .on("click",function(d){
            //     d3.select(this).transition().duration(1000).attr("r",radius(d.deaths)+10).attr("fill","red").transition().duration(1000).attr("r",radius(d.deaths))
            //     .transition().duration(1000).attr("r",radius(d.deaths)+10).transition().duration(1000).attr("r",radius(d.deaths))
            //     .transition().duration(1000).attr("r",radius(d.deaths)+10).transition().duration(1000).attr("r",radius(d.deaths))
            //     .transition().duration(1000).attr("r",radius(d.deaths)+10).transition().duration(1000).attr("r",radius(d.deaths))
            //     .transition().duration(1000).attr("r",radius(d.deaths)+10).transition().duration(1000).attr("r",radius(d.deaths)).transition().duration(1000).attr("fill","red")
              
            //   })
        
        
        
              var lasso_start = function() {
                    lasso.items() // reset size
                        .classed("not_possible",true)
                        .classed("selected",false)
                        .classed("selected1",false);
                };
        
                var lasso_draw = function() {
                
                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible",false)
                        .classed("possible",true)
                        .classed("selected1",false);
            
                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible",true)
                        .classed("possible",false)
                        .classed("selected1",false);
                };
        
                var lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible",false)
                        .classed("possible",false)
                        .classed("isselected",false);
        
                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected",true);
  
  
  
                        if(lasso.selectedItems()._groups[0].length==0)
                    {
                      d3.select(".res").text("Showing Results for All Countries");
                    }
                    if(lasso.selectedItems()._groups[0].length>0)
                    {
                    d3.select(".res").text("Showing Results for selected Countries");
                    }
                    
                        let d=[];
                    let cn=[];
                    for(i of lasso.selectedItems()._groups[0]){
                if(i.__data__!=null)
                {
                  d.push(i.__data__)
                  cn.push(i.__data__.country)
                }
        }
        store.currentselectedcountries=cn;
        store.afterlasso=d
        total_case_print(d)
        total_case_print1(d)
        total_case_print2(d)
  
        l= d3.selectAll("rect")._groups[0]
       for(i=0;i<205;i++)
       {
         if(cn.includes(l[i].__data__.country))
         {
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",true)
         }
         else{
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",false)
         }
       }
  
       if(d.length>0)aftermaplasso(d);
       else drawline(store.sumdate)
  
       if(store.currentcommand!=null)
         {
           console.log("asci")
           document.getElementById('command').value=store.currentcommand;
           command();
         }
                };
                
                var lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .items(circles)
                    .targetArea(container)
                    .on("start",lasso_start)
                    .on("draw",lasso_draw)
                    .on("end",lasso_end);
        
                container.call(lasso)
                lasso.items(container.selectAll('path'))
        
        
        }
        
        
        function drawCirclesRecovered(recoveredcircle,clr) {
          let config = getMapConfig(); 
          let projection = getMapProjection(config)
          let container = config.container; 
          container.innerHTML=""
          radius = d3.scaleSqrt([0,d3.max(recoveredcircle, d=> d.recovered)], [.5, config.width/40])
          let circles = container.selectAll("circle")
            .data(recoveredcircle)
            .enter()               //confiremedlates earlier//
          .append("circle")
          .attr("class", "confirmed")
            .attr("fill", clr)
            .attr("fill-opacity", ".15")
            .join("circle")
            .attr("transform", d => `translate(${projection([d.lon,d.lat])[0]},${projection([d.lon,d.lat])[1]})`)
            .attr("r", 0)//radius funtion previosly
            // .on("mouseenter", function(d) {
            //      // d3.select(this).attr("fill", "#229a5b")
            //      div
            //     .transition()
            //     .duration(200)
            //     .style("opacity", .9);
            //   div
            //   .html(
            //       "<b>COUNTRY: </b>" +
            //         d.country +
            //         "</br><b>CONFIRMED CASES: </b>" +
            //       d.confirmed +
            //       "</br><b>Death CASES: </b>" +
            //       d.deaths +
            //       "</br><b>Recovered CASES: </b>" +
            //       d.recovered +
            //         "</br>AS OF " +
            //       d.date
            //     )
            //     .attr("class","tooltip")
            //     .style("left", d3.event.pageX + "px")
            //     .style("top", d3.event.pageY - 28 + "px");
                 
            //     })
            //   .on("mouseleave",function(){
            //     div
            //     .attr("class","tooltip")
            //     .transition()
            //     .duration(500)
            //     .style("opacity", 0);
            //   })
            //   .on("click",function(d){
            //     d3.select(this).transition().duration(1000).attr("r",radius(d.recovered)+10).attr("fill","red").transition().duration(1000).attr("r",radius(d.recovered))
            //     .transition().duration(1000).attr("r",radius(d.recovered)+10).transition().duration(1000).attr("r",radius(d.recovered))
            //     .transition().duration(1000).attr("r",radius(d.recovered)+10).transition().duration(1000).attr("r",radius(d.recovered))
            //     .transition().duration(1000).attr("r",radius(d.recovered)+10).transition().duration(1000).attr("r",radius(d.recovered))
            //     .transition().duration(1000).attr("r",radius(d.recovered)+10).transition().duration(1000).attr("r",radius(d.recovered)).transition().duration(1000).attr("fill","green")
              
            //   })
        
        
        
              var lasso_start = function() {
                    lasso.items() // reset size
                        .classed("not_possible",true)
                        .classed("selected",false)
                        .classed("selected1",false);
                };
        
                var lasso_draw = function() {
                
                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible",false)
                        .classed("possible",true)
                        .classed("selected1",false);
            
                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible",true)
                        .classed("possible",false)
                        .classed("selected1",false);
                };
        
                var lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible",false)
                        .classed("possible",false)
                        .classed("isselected",false);
        
                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected",true);
                    
  
  
                        if(lasso.selectedItems()._groups[0].length==0)
                    {
                      d3.select(".res").text("Showing Results for All Countries");
                    }
                    if(lasso.selectedItems()._groups[0].length>0)
                    {
                    d3.select(".res").text("Showing Results for selected Countries");
                    }
  
                        let d=[];
                    let cn=[];
                    for(i of lasso.selectedItems()._groups[0]){
                if(i.__data__!=null)
                {
                  d.push(i.__data__)
                  cn.push(i.__data__.country)
                }
        }
        store.currentselectedcountries=cn;
        store.afterlasso=d
        total_case_print(d)
        total_case_print1(d)
        total_case_print2(d)
  
        l= d3.selectAll("rect")._groups[0]
       for(i=0;i<205;i++)
       {
         if(cn.includes(l[i].__data__.country))
         {
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",true)
         }
         else{
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",false)
         }
       }
  
       if(d.length>0)aftermaplasso(d);
       else drawline(store.sumdate)
  
       if(store.currentcommand!=null)
         {
           console.log("asci")
           document.getElementById('command').value=store.currentcommand;
           command();
         }
        
                };
                
                var lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .items(circles)
                    .targetArea(container)
                    .on("start",lasso_start)
                    .on("draw",lasso_draw)
                    .on("end",lasso_end);
        
                container.call(lasso)
                lasso.items(container.selectAll('path'))
        
        
        }
        
        
        function generate_region_list(data){
        
          
          
        
        let countries = [
          
        ];
        
        for(i of store.done)
        {
          
          countries.push(i.region);
        }
       countries= countries.sort()
       countries.unshift("All")
        ul = document.getElementById("countries");
        
        let render_lists = function(lists){
          let li = "";
          for(index in lists){
            li += "<option>" + lists[index] + "</option>";
          }
          ul.innerHTML = li;
        }
        
        
        
        render_lists(countries);
  
        $(".chosen").chosen();
        
        }
        
        
        function myScript(){
  
            var selectBox = document.getElementById("countries");
            var selectedValue = selectBox.options[selectBox.selectedIndex].value;
           
            store.currentselectedcountries=[];
            store.currentselectedcountries.push(selectedValue);
          
           let c=selectedValue;
           
           if(c=="All")d3.select(".res").text("Showing Results for All Countries");
           else d3.select(".res").text("Showing Results for "+c);
          
           l=d3.selectAll("rect")._groups[0];
           ln=d3.selectAll("rect")._groups[0].length;
           for(j=0;j<ln;j++)
            {
            
              
              d3.select(l[i]).classed("selected1",false)
                    d3.select(l[i]).classed("selected",false);
                    
              
              
            }
            l=d3.select("#G").selectAll("path")._groups[0]
            ln=d3.select("#G").selectAll("path")._groups[0].length
            for(i=0;i<ln;i++)
        {
          
          d3.select(l[i]).classed("selected",false);
          d3.select(l[i]).classed("selected1",false)
        }
            
           if(c=="All")
           {
            
         drawline(store.sumdate)
            total_case_print(store.done)
          total_case_print1(store.done)
          total_case_print2(store.done)
          for(j=0;j<205;j++)
            {
              i=d3.selectAll("rect")._groups[0][j];
              d3.select(i).classed("selected",false);
              d3.select(i).classed("selected1",false)
            }

           }

           l= d3.selectAll("rect")._groups[0]
        ln=d3.selectAll("rect")._groups[0].length
       for(i=0;i<ln-115;i++)
       {
         if(l[i].__data__.region==c)
         {
           d3.select(l[i]).classed("selected",true)
         }
         else{
           d3.select(l[i]).classed("selected",false)
         }
       }
            l=d3.select("#G").selectAll("path")._groups[0]
            ln=d3.select("#G").selectAll("path")._groups[0].length
            for(i=0;i<ln-3;i++)
        {
          if(l[i].__data__.properties.STATE_NAME==c){
                    d3.select(l[i]).classed("selected",true);
              }
        }
           
            
  
      
            
            
        }
  
        function myScript1(e){
          
          let c=e
        
            
            l=d3.select("#G").selectAll("path")._groups[0]
            ln=d3.select("#G").selectAll("path")._groups[0].length
            for(let i=0;i<ln-4;i++)
            {
              if(l[i].__data__.properties.STATE_NAME==c)
              {
                d3.select(l[i]).classed("selected",true);
              }
              else{
                d3.select(l[i]).classed("selected",false);

              }
              
            }
           
           
       }

       function myScript2(e)
       {
        let c=e
        
            
        l=d3.selectAll("rect")._groups[0]
        ln=d3.selectAll("rect")._groups[0].length
        for(let i=0;i<ln-116;i++)
        {
          if(l[i].__data__.region==c)
          {
            d3.select(l[i]).classed("selected",true);
          }
          else{
            d3.select(l[i]).classed("selected",false);

          }
          
        }
       }
        
        function total_case_print(data)
        {
          let cf=0;
          let d;
          if(data.length!=0){
            for(i of data)
            {
              cf+=i.confirmed;
        d=i.date;
            }
            d3.select(".tc").html(
  "<span style='font-weight:bold;font-size:1.5em;color:#2a5599'>"+cf+"</span>"+ 
  "</br>"+"Confirmed Cases"
                  
                )
            
        }
        else{
          data=store.done
          for(i of data)
            {
              cf+=i.confirmed;
        d=i.date;
            }
            d3.select(".tc").html(
                "<span style='font-weight:bold;font-size:1.5em;color:#2a5599'>"+cf+"</span>"+
  "</br>"+"Confirmed Cases"
                )
          
          
        }
        }
        
        function total_case_print1(data)
        {
          let cf=0;
          let d;
          if(data.length!=0){
            for(i of data)
            {
              cf+=i.deaths;
        d=i.date;
            }
            d3.select(".tc1").html(
                "<span style='font-weight:bold;font-size:1.5em;color:#cb181d'>"+cf+"</span>"+
  "</br>"+"Deaths"
                )
            
        }
        else{
          data=store.done
          for(i of data)
            {
              cf+=i.deaths;
        d=i.date;
            }
            d3.select(".tc1").html(
                "<span style='font-weight:bold;font-size:1.5em;color:#cb181d'>"+cf+"</span>"+
  "</br>"+"Deaths"
                )
            
          
        }
        }
        
        
        function total_case_print2(data)
        {
          let cf=0;
          let d;
          if(data.length!=0){
            for(i of data)
            {
              cf+=i.recovered;
        d=i.date;
            }
            d3.select(".tc2").html(
                "<span style='font-weight:bold;font-size:1.5em;color:#238b45'>"+cf+"</span>"+
  "</br>"+"People Recovered"
                )
            
        }
        else{
          data=store.done
          for(i of data)
            {
              cf+=i.recovered;
        d=i.date;
            }
            d3.select(".tc2").html(
                "<span style='font-weight:bold;font-size:1.5em;color:#238b45'>"+cf+"</span>"+
  "</br>"+"People Recovered"
                )
            
          
        }
        }

        function total_case_print3(data)
        {
          let cf=0;
          let d;
          if(data.length!=0){
            for(i of data)
            {
              cf+=i.active;
        d=i.date;
            }
            d3.select(".tc3").html(
                "<span style='font-weight:bold;font-size:1.5em;color: orange'>"+cf+"</span>"+
  "</br>"+"Active Cases"
                )
            
        }
        else{
          data=store.done
          for(i of data)
            {
              cf+=i.active;
        d=i.date;
            }
            d3.select(".tc3").html(
                "<span style='font-weight:bold;font-size:1.5em;color: orange'>"+cf+"</span>"+
  "</br>"+"Active Cases"
                )
            
          
        }
        }
        
        function ddl()
        {
          var selectBox = document.getElementById("options");
            var selectedValue = selectBox.options[selectBox.selectedIndex].value;
            //console.log("hello")
            //drawCirclesdeath(groupbyCountryDeath(store.death),"#ff9500")
            //drawCircles(groupbyCountryDeath(store.death),)
            if(selectedValue=="Death Cases"){
              currentvis="death";
            document.getElementById("countries").value="All";
            $("#countries").trigger("chosen:updated");
            d3.select("#G").remove()
            d3.select("#Map").append("g").attr("id","G")
            d3.select("#BarChart").remove()
            d3.select("#Bar").append("svg").attr("id","BarChart").attr("transform", "rotate(90)")
            drawbar(store.done.sort((a,b)=>b.deaths - a.deaths))
            drawMap(prep(store.geoJSON))
            drawline(store.sumdate)
            //drawCirclesdeath(store.done,"red")
            total_case_print(store.done)
          total_case_print1(store.done)
          total_case_print2(store.done)
          total_case_print3(store.done)
          //d3.select(".res").text("Showing Results of Death Cases for All Countries");
          
            }
            else if(selectedValue=="Confirmed Cases")
        
            {
              currentvis="confirm";
              document.getElementById("countries").value="All";
            $("#countries").trigger("chosen:updated");
              d3.select("#G").remove()
            d3.select("#Map").append("g").attr("id","G")
            d3.select("#BarChart").remove()
            d3.select("#Bar").append("svg").attr("id","BarChart").attr("transform", "rotate(90)")
            drawbar(store.done.sort((a,b)=>b.confirmed - a.confirmed))
            drawMap(prep(store.geoJSON))
            drawline(store.sumdate)
           // drawCircles(store.done,"blue")
            total_case_print(store.done)
          total_case_print1(store.done)
          total_case_print2(store.done)
          total_case_print3(store.done)
          //d3.select(".res").text("Showing Results of Confirmed Cases for All Countries");
            }
            else if(selectedValue=="Recovered Cases")
            {
              currentvis="recovered";
              document.getElementById("countries").value="All";
            $("#countries").trigger("chosen:updated");
              d3.select("#G").remove()
            d3.select("#Map").append("g").attr("id","G")
            d3.select("#BarChart").remove()
            d3.select("#Bar").append("svg").attr("id","BarChart").attr("transform", "rotate(90)")
            drawbar(store.done.sort((a,b)=>b.recovered - a.recovered))
            drawMap(prep(store.geoJSON))
            drawline(store.sumdate)
           // drawCirclesRecovered(store.done,"red")
            total_case_print(store.done)
          total_case_print1(store.done)
          total_case_print2(store.done)
          total_case_print3(store.done)
         // d3.select(".res").text("Showing Results of Recovered Cases for All Countries");
            }
            else if(selectedValue=="Active Cases")
            {
              currentvis="active";
              document.getElementById("countries").value="All";
            $("#countries").trigger("chosen:updated");
              d3.select("#G").remove()
            d3.select("#Map").append("g").attr("id","G")
            d3.select("#BarChart").remove()
            d3.select("#Bar").append("svg").attr("id","BarChart").attr("transform", "rotate(90)")
            drawbar(store.done.sort((a,b)=>b.active - a.active))
            drawMap(prep(store.geoJSON))
            drawline(store.sumdate)
           // drawCirclesRecovered(store.done,"red")
            total_case_print(store.done)
          total_case_print1(store.done)
          total_case_print2(store.done)
          total_case_print3(store.done)
            }
            
        }
  
  let lassobar;
        function drawbar(data){
     //console.log(data)
      lassobar = data;
               
  var margin =  {top: 10, right: 0, bottom: 115, left: 50};
  var marginOverview = {top: 10, right: 0, bottom: 70, left: 50};
  var selectorHeight = 15;
  var width = 500 - margin.left - margin.right;
  var height = 380 - margin.top - margin.bottom - selectorHeight;
  var heightOverview = 80 - marginOverview.top - marginOverview.bottom;
       
  var maxLength = d3.max(data.map(function(d){ return d.country.length}))
  var barWidth = 20;
  var numBars = Math.round(width/barWidth);
  var isScrollDisplayed = barWidth * data.length > width;
       
  
  // console.log(isScrollDisplayed)
  
  var xscale = d3.scaleBand()
                .domain(data.slice(0,numBars).map(function (d) { return d.region; }))
                .range([0, width])
                .padding(.2);
  
  var yscale = d3.scaleLinear()
              .domain([0, d3.max(data, function (d) { 
                                if(currentvis=="confirm")
                                {
                                    return d.confirmed;
                                }
                                else if(currentvis=="death")
                                {
                                    return d.deaths;
                                }
                                else if(currentvis=="recovered"){
                                    return d.recovered;
                                }
                                else{
                                  return d.active;
                                }
                                 })])
              .range([height, 0]);
  
  var xAxis  = d3.axisBottom(xscale);
  var yAxis  = d3.axisLeft(yscale).ticks(6).tickFormat(d3.format(".02s"));
  
  var svg = d3.select("#BarChart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom + selectorHeight);
  
  var diagram = svg.append("g")
                 .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
  diagram.append("g")
       .attr("class", "x axis")
       .attr("transform", "translate(0, " + height + ")")
       .call(xAxis)
       .selectAll("text")	
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", "-.5em")
            .attr("transform", function(d) {
                return "rotate(-90)" 
                });
  
  diagram.append("g")
       .attr("class", "y axis")
       .call(yAxis)
       .selectAll("text")	
            .style("text-anchor", "end")
            .style("font-size","12px")
  var bars = diagram.append("g");
  
  bars.selectAll("rect")
            .data(data.slice(0, numBars), function (d) {return d.region; })
            .enter()
            .append("rect")
            .attr("fill", function(d)
            {
              if(currentvis=="confirm")return "#2a5599";
              else if(currentvis=="death")return '#cb181d';//'#005a32''#99000d'  '#cb181d''#238b45'
              else if(currentvis=="recovered") return '#238b45';
              else if(currentvis=='active')return "orange";
            })                                         //"#2a5599"
            .attr("x", function (d) { return xscale(d.region); })
            .attr("y", function (d) { 
                                if(currentvis=="confirm")
                                {
                                    return yscale(d.confirmed);
                                }
                                else if(currentvis=="death")
                                {
                                    return yscale(d.deaths);
                                }
                                else if(currentvis=="recovered"){
                                    return yscale(d.recovered);
                                }
                                else{
                                  return yscale(d.active);
                                }
                 })
            .attr("width", xscale.bandwidth())
            .attr("height", function (d) { 
                                if(currentvis=="confirm")
                                {
                                    return height - yscale(d.confirmed);
                                }
                                else if(currentvis=="death")
                                {
                                    return height - yscale(d.deaths);
                                }
                                else if(currentvis=="recovered"){
                                    return height - yscale(d.recovered);
                                }
                                else if(currentvis=="active"){
                                  return height - yscale(d.active)
                                }
                 })
                 .on("mouseenter", function(d) {
                  d3.select(this).attr("fill", "#992a5b")
                  //myScript1(d.country);
                 
                 
                })
                .on("mousemove",function(d){
                  div
                .transition()
                .duration(200)
                .style("opacity", .9);
              div
              .html(
                  "<b>REGION: </b>" +
                    d.region +
                    "</br><b>CONFIRMED CASES: </b>" +
                  d.confirmed +
                  "</br><b>Death CASES: </b>" +
                  d.deaths +
                  "</br><b>Recovered CASES: </b>" +
                  d.recovered +
                  "</br><b>ACTIVE CASES: </b>" +
                  d.active +
                    "</br>AS OF " +
                  d.date
                )
                .attr("class","tooltip")
                .style("left", d3.event.clientX + "px")
                .style("top", d3.event.clientY - 28 + "px");
                })
              .on("mouseleave",function(){
                d3.select(this).attr("fill", function(d)
            {
              if(currentvis=="confirm")return "#2a5599";
              else if(currentvis=="death")return '#cb181d';//'#005a32''#99000d'  '#cb181d''#238b45'
              else if(currentvis=="recovered") return '#238b45';
              else if(currentvis=="active")return "orange";
            })   
                div
                .attr("class","tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
              })
            .on("click", d=>{
                //console.log(d.country);
                l=d3.selectAll('rect')._groups[0]
                ln=d3.selectAll('rect')._groups[0].length
                for(let i=0;i<ln-116;i++)
                {
                  if(l[i].__data__.region==d.region)
                  {
                    d3.select(l[i]).classed('selected',true);
                  }
                  else{
                    d3.select(l[i]).classed('selected',false);

                  }
                }
                let c=[]
                c.push(d)
                 myScript1(d.region);
                 total_case_print(c)
                 total_case_print1(c)
                 total_case_print2(c)
                 total_case_print3(c)
                 let g=[]
                 g.push({__data__ : d})
                 afterbarlasso(g)
                 
        //        // drawline(d.country, store.coronadat)
  
        //        for ( s of store.time){
        //    if( s.key == d.country){ linedata = s; break}
        //  }
        // // console.log(linedata.values)
        // slidedata = linedata.values;
        //  drawline(linedata.values)
         
        });
  
    
  
      var lasso_start = function() {
                    lasso.items() // reset size
                        .classed("not_possible",true)
                        .classed("selected",false)
                        .classed("selected1",false);
                };
        
                var lasso_draw = function() {
                
                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible",false)
                        .classed("possible",true)
                        .classed("selected1",false);
            
                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible",true)
                        .classed("possible",false)
                        .classed("selected1",false);
                };
        
                var lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible",false)
                        .classed("possible",false)
                        .classed("isselected",false)
                        
        
                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected",true);
                    
                    let d=[];
                    let cn=[]
                    let dn=[]
                    if(lasso.selectedItems()._groups[0].length==0)
                    {
                      d3.select(".res").text("Showing Results for All Countries");
                    }
                    if(lasso.selectedItems()._groups[0].length>0)
                    {
                    d3.select(".res").text("Showing Results for selected Countries");
                    }
                    for(i of lasso.selectedItems()._groups[0]){
                if(i.__data__!=null)
                {
                  d.push(i.__data__)
                  cn.push(i.__data__.country)
                  dn.push(i.__data__.region)
                }
        }
        store.currentselectedcountries=cn;

        total_case_print(d)
        total_case_print1(d)
        total_case_print2(d)
        total_case_print3(d)
        store.afterlasso=d
        
       l= d3.select("#G").selectAll("path")._groups[0]
       ln=d3.select("#G").selectAll("path")._groups[0].length
       for(i=0;i<ln-4;i++)
       {
         console.log(l[i].__data__)
         if(dn.includes(l[i].__data__.properties.STATE_NAME))
         {
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",true)
         }
         else{
           d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",false)
         }
       }
       let g=[]
       for(i of d)
       {
         g.push({
           __data__ : i
         })
       }
       
       if(d.length>0)afterbarlasso(g);
       if(d.length==0) drawline(store.sumdate)
      //  if(store.currentcommand!=null)
      //    {
      //      console.log("asci")
      //      document.getElementById('command').value=store.currentcommand;
      //      command();
      //    }
  
                };
                
                var lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .targetArea(svg)
                    .on("start",lasso_start)
                    .on("draw",lasso_draw)
                    .on("end",lasso_end);
        
                svg.call(lasso)
                lasso.items(svg.selectAll('rect'))
  
            
  
  if (isScrollDisplayed)
  {
  var xOverview = d3.scaleBand()
                  .domain(data.map(function (d) { return d.country; }))
                  .range([0, width])
                  .padding(.2);
  yOverview = d3.scaleLinear().range([heightOverview, 0]);
  yOverview.domain(yscale.domain());
  
  var subBars = diagram.selectAll('.subBar')
      .data(data)
  
  subBars.enter().append("rect")
      .classed('subBar', true)
      .attr({
          height: function(d) {
                               if(currentvis=="confirm")
                                {
                                    return heightOverview - yOverview(d.confirmed);
                                }
                                else if(currentvis=="death")
                                {
                                    return heightOverview - yOverview(d.deaths);
                                }
                                else{
                                    return heightOverview - yOverview(d.recovered);
                                }
  
              
          },
          width: function(d) {
              return xOverview.bandwidth()
          },
          x: function(d) {
  
              return xOverview(d.country);
          },
          y: function(d) {
              
                                if(currentvis=="confirm")
                                {
                                    return height + heightOverview + yOverview(d.confirmed)
                                }
                                else if(currentvis=="death")
                                {
                                    return height + heightOverview + yOverview(d.deaths)
                                }
                                else{
                                    return height + heightOverview + yOverview(d.recovered)
                                }
  
              
          }
      })
  
  var displayed = d3.scaleQuantize()
              .domain([0, width])
              .range(d3.range(data.length));
  
  diagram.append("rect")
              .attr("transform", "translate(0, " + (height + margin.bottom) + ")")
              .attr("class", "mover")
              .attr("x", 0)
              .attr("y", 0)
              .attr("height", selectorHeight)
              .attr("width", Math.round(parseFloat(numBars * width)/data.length))
              .attr("pointer-events", "all")
              .attr("cursor", "all-scroll")
              .call(d3.drag().on("drag", display));
  }
  function  display () {
    var x = parseInt(d3.select('.mover').attr("x")),
        nx = x + d3.event.dx,
        w = parseInt(d3.select('.mover').attr("width")),
        f, nf, new_data, rects;
      
    if ( nx < 0 || nx + w > width ) return;
  
    d3.select(this).attr("x", nx);
  
    f = displayed(x);
    nf = displayed(nx);
  
    if ( f === nf ) return;
  
    new_data = data.slice(nf, nf + numBars);
  
    xscale.domain(new_data.map(function (d) { return d.country; }));
    diagram.select(".x.axis").call(xAxis).selectAll("text")	
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", "-.5em")
            .attr("transform", function(d) {
                return "rotate(-90)" 
                });
  
    rects = bars.selectAll("rect")
      .data(new_data, function (d) {return d.country; });
  
    rects.attr("x", function (d) { return xscale(d.country); });
  
    rects.enter().append("rect")
    .attr("fill", function(d)
            {
              if(currentvis=="confirm")return "#2a5599";
              else if(currentvis=="death")return '#cb181d';//'#005a32''#99000d' 
              else if(currentvis=="recovered") return '#238b45';
            })   
      .attr("x", function (d) { return xscale(d.country); })
      .attr("y", function (d) { if(currentvis=="confirm")
                                {
                                    return yscale(d.confirmed);
                                }
                                else if(currentvis=="death")
                                {
                                    return yscale(d.deaths);
                                }
                                else{
                                    return yscale(d.recovered);
                                } })
      .attr("width", xscale.bandwidth())
      .attr("height", function (d) {
                                 if(currentvis=="confirm")
                                {
                                    return height - yscale(d.confirmed);
                                }
                                else if(currentvis=="death")
                                {
                                    return height - yscale(d.deaths);
                                }
                                else{
                                    return height - yscale(d.recovered);
                                }
            }).on("mouseenter", function(d) {
                  d3.select(this).attr("fill", "#992a5b")
                  // myScript1(d.country);
                 
                 
                })
                .on("mousemove",function(d){
                  div
                .transition()
                .duration(200)
                .style("opacity", .9);
              div
              .html(
                  "<b>COUNTRY: </b>" +
                    d.country +
                    "</br><b>CONFIRMED CASES: </b>" +
                  d.confirmed +
                  "</br><b>Death CASES: </b>" +
                  d.deaths +
                  "</br><b>Recovered CASES: </b>" +
                  d.recovered +
                    "</br>AS OF " +
                  d.date
                )
                .attr("class","tooltip")
                .style("left", d3.event.clientX + "px")
                .style("top", d3.event.clientY - 28 + "px");
                })
              .on("mouseleave",function(){
                d3.select(this).attr("fill", function(d)
            {
              if(currentvis=="confirm")return "#2a5599";
              else if(currentvis=="death")return '#cb181d';//'#005a32''#99000d'  '#cb181d''#238b45'
              else if(currentvis=="recovered") return '#238b45';
            })   
                div
                .attr("class","tooltip")
                .transition()
                .duration(500)
                .style("opacity", 0);
              })
            .on("click", d=>{
                //console.log(d.country);
                 myScript1(d.region);
                 for ( s of store.time){
           if( s.key == d.country){ linedata = s; break}
         }
        // console.log(linedata.values)
        slidedata = linedata.values;
         drawline(linedata.values)
               // drawline(d.country, store.coronadat)
        });
  
  
  
  
  
        var lasso_start = function() {
                    lasso.items() // reset size
                        .classed("not_possible",true)
                        .classed("selected",false)
                        .classed("selected1",false);
                };
        
                var lasso_draw = function() {
                
                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible",false)
                        .classed("possible",true)
                        .classed("selected1",false);
            
                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible",true)
                        .classed("possible",false)
                        .classed("selected1",false);
                };
        
                var lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible",false)
                        .classed("possible",false)
                        .classed("isselected",false)
                        
        
                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected",true);
                    
                    let d=[];
                    let cn=[]
                    if(lasso.selectedItems()._groups[0].length==0)
                    {
                      d3.select(".res").text("Showing Results for All Countries");
                    }
                    if(lasso.selectedItems()._groups[0].length>0)
                    {
                    d3.select(".res").text("Showing Results for selected Countries");
                    }
                    for(i of lasso.selectedItems()._groups[0]){
                if(i.__data__!=null)
                {
                  d.push(i.__data__)
                  cn.push(i.__data__.country)
                }
        }
        store.currentselectedcountries=cn;
        total_case_print(d)
        total_case_print1(d)
        total_case_print2(d)
  
        store.afterlasso=d
        
       l= d3.select("#G").selectAll("path")._groups[0]
       for(i=0;i<180;i++)
       {
         if(cn.includes(l[i].__data__.country))
         {
          d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",true)
         }
         else{
           d3.select(l[i]).classed("selected1",false)
           d3.select(l[i]).classed("selected",false)
         }
       }
  
       if(d.length>0)afterbarlasso(lasso.selectedItems()._groups[0]);
       else drawline(store.sumdate)
       if(store.currentcommand!=null)
         {
           console.log("asci")
           document.getElementById('command').value=store.currentcommand;
           command();
         }
  
                };
                
                var lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .targetArea(svg)
                    .on("start",lasso_start)
                    .on("draw",lasso_draw)
                    .on("end",lasso_end);
        
                svg.call(lasso)
                lasso.items(svg.selectAll('rect'))
  
  
  
  
  
  
        let l= d3.selectAll("rect")._groups[0]
        let ln=d3.selectAll("rect")._groups[0].length-6
       for(i=0;i<ln;i++)
       {
        
        
         if(store.currentselectedcountries.includes(l[i].__data__.country) || store.currentselectedcountries.includes(l[i].__data__.country.toLowerCase()))
         {
           
          
           d3.select(l[i]).classed("selected",true)
          
  
         }
         else{
           d3.select(l[i]).classed("selected",false)
         }
       }
        
  
    rects.exit().remove();
  };
  
  
  }
  
  ////Bar end
  
  
  
  
  function drawline(data){
  
  // draw line here
  let body = d3.select("#body2")
  document.getElementById("body2").innerHTML="";
  let height = 450;
  let width = 530;
  data.map(function(d){
   d.date= new Date(d.date)
   if(currentvis=="confirm")  d.confirmed = +d.confirmed;
   else if(currentvis=="death")  d.deaths =+d.deaths;
   else if(currentvis=="recovered") d.recovered =+d.recovered;
   else if(currentvis=="active")d.active =+d.active;
  })
  
  let max = d3.max(data,function(d)
  {
    if(currentvis=="confirm")return d.confirmed;
    else if(currentvis=="death") return d.deaths;
    else if(currentvis=="recovered")return d.recovered;
    else if(currentvis=="active")return d.active;
  })
  //else if(currentvis=="death")let max = d3.max(data,d=>d.deaths)
  let barmax = d3.max(data,function(d){
    if(currentvis=="confirm")return d.new_case;
    else if(currentvis=="death") return d.new_death_case;
    else if(currentvis=="recovered")return d.new_recovered_case;
    else if(currentvis=="active")return d.new_active_case;

  })
  let Yscale = d3.scaleLinear()
  .domain([0,barmax])
  .range([height,0])
  let yscale = d3.scaleLinear()
  .domain([0,max])
  .range([height,0])
  body.append("g")
  .call(d3.axisLeft(yscale)
          .ticks(15)
          .tickFormat(d3.format(".02s")));
  var nh = width+5;
  body.append("g")
  .attr("transform", "translate("+nh+",0)")
  .call(d3.axisRight(Yscale)
          .ticks(15)
          .tickFormat(d3.format(".02s")));
  
  
  let xscale = d3.scaleTime()
  .domain(d3.extent(data,d=>d.date))
  .range([0,width])
  body.append("g")
  .attr("transform", "translate(0,"+height+")")
  .call(d3.axisBottom(xscale)
  .tickFormat(d3.timeFormat("%d %b")))
  .selectAll("text")  
              .style("text-anchor", "end")
              .attr("dx", "-.8em")
              .attr("dy", ".15em")
              .attr("transform", "rotate(-65)" );
  
  var valueline = d3.line()
  .x(d => xscale(d.date))
  .y(function(d){
    if(currentvis=="confirm") return yscale(d.confirmed);
    else if(currentvis=="death") return yscale(d.deaths);
    else if(currentvis=="recovered")return yscale(d.recovered);
    else if(currentvis=="active")return yscale(d.active);
  })
  .defined(function(d){
    if(currentvis=="confirm") return !!d.confirmed;
    else if(currentvis=="death") return !!d.deaths;
    else if(currentvis=="recovered")return !!d.recovered;
    else if(currentvis=="active")return !!d.active;
  })
  //for tooltip
     // bar chart here
     body.selectAll(".bar")
    .data(data)
  .enter().append("rect")
    .attr("fill", function()
    {
      return "#00abab";
    })
    .attr("class", "bar")
    .style("margin-top", "10px")
    .attr("x", function(d) { return xscale(d.date); })
    .attr("width", "4px")
    .attr("y", function(d) {
      if(currentvis=="confirm") return Yscale(d.new_case);
    else if(currentvis=="death") return Yscale(d.new_death_case);
    else if(currentvis=="recovered")return Yscale(d.new_recovered_case);
    else if(currentvis=="active")return Yscale(d.new_active_case);
   })
    .attr("height", function(d) { 
      if(currentvis=="confirm") return height - Yscale(d.new_case);
    else if(currentvis=="death") return height - Yscale(d.new_death_case);
    else if(currentvis=="recovered")return height - Yscale(d.new_recovered_case);
    else if(currentvis=="active")return height - Yscale(d.new_active_case);
    });
    //end
            
  body.append('rect')
      .style("fill", "none")
      .style("pointer-events", "all")
      .attr('width', width)
      .attr('height', height)
      .on('mousemove', mousemove);
  
  //tool tip
  body
  .append("path")
  .datum(data)
  .attr("fill", "none")
  .attr("stroke", function()
  {
    if(currentvis=="confirm") return "#2a5599";
    else if(currentvis=="death") return '#cb181d';
    else if(currentvis=="recovered")return '#238b45';
    else if(currentvis=="active")return 'orange';
  })
  .attr("stroke-width", 3)
  .attr("d", valueline)
  .attr("class", "line")
  .on("mouseenter", d=>{
              
        showtool([d3.event.clientX -180, d3.event.clientY-30])
      })
  .on("mouseleave", d=>{
        d3.select("#tooltip").style('display', 'none')
      })
    .on("mousemove", d=>{
        showtool([d3.event.clientX -180, d3.event.clientY-30])
      })
  
  //draw line end 
  
  /// for tooltip
  
  var bisect = d3.bisector(function(d) { return d.date; }).left;
  function mousemove() {
          // recover coordinate we need
          var x0 = xscale.invert(d3.mouse(this)[0]);
          var i = bisect(data, x0, 1);
          selectedData = data[i]
          a= selectedData
  
         
          
  }
  
  function showtool(coord){
   var val
   var cas

   if(currentvis=="confirm") {
    val = a.confirmed
    cas = "Confirmed: "
   }
    else if(currentvis=="death")
    {
          val = a.deaths
      cas = "Deaths: "
    }
    else if(currentvis=="recovered")
    {
    val = a.recovered
      cas = "Recovered: "
    }
    else if(currentvis=="active")
    {
    val = a.active
      cas = "Active: "
    }

    var formatDate = d3.timeFormat("%d-%b-%y")
  
    
  
          d3.select("#tooltip")
              .html(cas+val+"<br> Date: "+ formatDate(a.date))
              .style('top', coord[1]-15+"px")
              .style("left", coord[0]+15+"px")
              .style("display", "block")
              .style("color", "blue")
              
      }
       

  var columnHeaders = ["Daily","Deaths", "Recovered", "Confirmed"];
  var color = d3.scaleOrdinal().range(
    ["#2a5599" ,'#238b45','#cb181d',"#00abab"]);
  
    var legend = body.selectAll(".legend")
      .data(columnHeaders.slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
  
  legend.append("rect")
      .attr("x", 105)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);
  
  legend.append("text")
      .attr("x", 90)
      .attr("y", 5)
      .attr("dy", ".35em")
      .style("fill", color)
      .style("text-anchor", "end")
      .text(function(d) { return d; });
  
  //
  
  
  //console.log(data)
  
  
  
  body.append('g')
      .selectAll("dot")
      .data(data)
      .enter()
      .append("circle")
        .attr("cx", function (d) { return xscale(d.date); } )
        .attr("cy", function (d) { 
          if(currentvis=="confirm") return yscale(d.confirmed);
    else if(currentvis=="death") return yscale(d.deaths);
    else if(currentvis=="recovered")return yscale(d.recovered);
    else if(currentvis=="active")return yscale(d.active);
           } )
        .attr("case", function()
        {
          if(currentvis=="confirm") return "confirm";
    else if(currentvis=="death")return "death";
    else if(currentvis=="recovered")return "recovered";
    else if(currentvis=="active")return "active";
        })
        .classed('selected1',true)
        .attr("r", 2.5)
        .style("fill", "white")//#69b3a2
      //   body.append('g')
      // .selectAll("dot")
      // .data(data)
      // .enter()
      // .append("circle")
      //   .attr("cx", function (d) { return xscale(d.date); } )
      //   .attr("cy", function (d) { return yscale(d.recovered); } )
      //   .attr("case", "recovered")
      //   .attr("r", 0)
      //   .style("fill", "red")//#69b3a2
      //   body.append('g')
      // .selectAll("dot")
      // .data(data)
      // .enter()
      // .append("circle")
      //   .attr("cx", function (d) { return xscale(d.date); } )
      //   .attr("cy", function (d) { return yscale(d.deaths); } )
      //   .attr("case", "death")
      //   .attr("r", 0)
      //   .style("fill", "red")//#69b3a2
  lasso(yscale(1), data, xscale)
  
  
  }
  
  
  
   
        loadData().then(showData);
    
  //lasso here
  let a;
  function lasso(scal, data, xscale){
    let body = d3.select("#container")
    var circles = body.selectAll("circle")
    // Lasso functions
          var lasso_start = function() {
              lasso.items()
                  .attr("r",0) // reset size
                  .classed("not_possible",true)
                  .classed("selected",false);
          };
  
          var lasso_draw = function() {
          
              
              lasso.possibleItems()
                  .classed("not_possible",false)
                  .classed("possible",true);
                  
                 
                  
                
                 
                  //console.log("I am from lasso data")
  
                  
              
              lasso.notPossibleItems()
                  .classed("not_possible",true)
                  .classed("possible",false);
          };
          var lasso_end = function() {
              // Reset the color of all dots
              lasso.items()
                  .classed("not_possible",false)
                  .classed("possible",false);
                  let fcircle = lasso.selectedItems()
                  let newcir = lasso.selectedItems()._groups[0].filter(function(d){ return d.getAttribute("case") == currentvis})
                  fcircle._groups[0] = newcir;
              // Style the selected dots
              fcircle
                  .classed("selected",true)
                  .attr("r",2.5)
                  .style("fill", "yellow");
                  var lassod = fcircle._groups[0]
                  var bisect = d3.bisector(function(d) { return d.date; }).left;
                  let a = lassod;
                  if(a.length){
                  var x1 =xscale.invert(a[0].cx.baseVal.value);
                  var x2 =xscale.invert(a[a.length-1].cx.baseVal.value);
                  afterlasso(x1,x2)
                  var formatDate = d3.timeFormat("%d/%b/%y")
                  d3.select(".res").text("Showing Results from "+formatDate(x1)+" to "+formatDate(x2));
                  }
                  if(!a.length){
                    clearmap()
                    drawMap(prep(store.geoJSON))
                    clearbar()
                    total_case_print(store.done);
            total_case_print1(store.done);
            total_case_print2(store.done);
                    d3.select(".res").text("Showing Results for All Countries");
                    if(currentvis=="confirm")drawbar(store.done.sort((a,b)=>b.confirmed - a.confirmed));
                    else if(currentvis=="death")drawbar(store.done.sort((a,b)=>b.deaths - a.deaths));
                    else if(currentvis=="recovered")drawbar(store.done.sort((a,b)=>b.recovered - a.recovered));
                  }
              // Reset the style of the not selected dots
              lasso.notSelectedItems()
                  .attr("r",0);
  
            //console.log(lasso.selectedItems());
  
          };
          
          var lasso = d3.lasso()
              .closePathSelect(true)
              .closePathDistance(100)
              .items(circles)
              .targetArea(body)
              .on("start",lasso_start)
              .on("draw",lasso_draw)
              .on("end",lasso_end);
          
          body.call(lasso);
  }
  setTimeout(slide,2000)
   //end lasso
   function slide(){
     var len = slidedata.length
    /*var d1 = new Date(data[2].date)
    var d2 = new Date(data[0].date)
    Math.abs(d1-d2)/86400000*/
    //console.log(slidedata[len-1].date)
     
    $(function() {
      $( "#slider-range" ).slider({
        range: true,
        min: new Date(slidedata[0].date).getTime() / 1000,
        max: new Date(slidedata[len-1].date).getTime() / 1000,
        step: 86400,
        values: [ new Date(slidedata[0].date).getTime() / 1000, new Date(slidedata[len-1].date).getTime() / 1000 ],
        slide: function( event, ui ) { //console.log((new Date(ui.values[ 0 ] *1000) ))
          var d1 = new Date(ui.values[ 0 ] *1000)
          var d2 = new Date(ui.values[ 1 ] *1000)
          var d3 = new Date(slidedata[0].date).getTime()
          var str = Math.abs(d1-d3)/86400000
          var end = Math.abs(d2-d3)/86400000
          afterlasso(d1, d2)
          drawline(slidedata.slice(str,end))
          if(store.currentcommand!=null){
             command()
          }
          
          $( "#amount" ).val( (new Date(ui.values[ 0 ] *1000).toDateString() ) + " - " + (new Date(ui.values[ 1 ] *1000)).toDateString() );
        }
      });
      $( "#amount" ).val( (new Date($( "#slider-range" ).slider( "values", 0 )*1000).toDateString()) +
        " - " + (new Date($( "#slider-range" ).slider( "values", 1 )*1000)).toDateString());
        
    });
   }
  

  
     //after lasso
  
     function afterlasso(d1,d2){
                
           console.log(d1,d2)
          var d3 = new Date(slidedata[0].date).getTime()
          var str = Math.abs(d1-d3)/86400000
          var end = Math.abs(d2-d3)/86400000
          let a = [];
          
          str = Math.floor(str)
          end = Math.floor(end)
          var j = 0;
          //console.log(store.time)
        
          for( x of store.time){
            let c=0;
            let d=0;
            let r=0;
            let k=0;
            
               c += x.values[end].confirmed - x.values[str].confirmed
               d += x.values[end].deaths - x.values[str].deaths
               r += x.values[end].recovered - x.values[str].recovered
               k += x.values[end].active - x.values[str].active
            
            a[j] = {
              "country" : x.values[0].country,
              "region" : x.values[0].region,
              "confirmed" : c,
              "recovered" : r,
              "deaths" : d,
              "date" :   x.values[end].date,
               "active" : k      }
            j++;
          }
          
          
          if(currentvis=="confirm")a = a.sort((a,b)=>b.confirmed-a.confirmed);
          else if(currentvis=="death")a = a.sort((a,b)=>b.deaths - a.deaths);
          else if(currentvis=="recovered")a = a.sort((a,b)=>b.recovered -a.recovered)
          else if(currentvis=="active")a = a.sort((a,b)=>b.active -a.active)
          
  
  
          
          for(i=0;i<a.length;i++)
            {
                
                b=a[i].region;
                
                for (j of store.geoJSON.features)
                {
                    if(j.properties.STATE_NAME==b)
                    {
                        j.confirmed=a[i].confirmed;
                        j.deaths=a[i].deaths;
                        j.recovered=a[i].recovered;
                        j.country=a[i].country;
                        j.active=a[i].active;
                        break;
                    }
                    else {
                      if(!('country' in j))
                      {
                        j.country=""
                      }
                    }
                    
                }
            }
            for (i of store.geoJSON.features)
            {
                if(!('confirmed' in i)){
                    i.confirmed=0;
                    i.deaths=0
                    i.recovered=0
                    i.active=0
                }
            }
  
            total_case_print(a);
            total_case_print1(a);
            total_case_print2(a);
            total_case_print3(a);
            console.log(a)
            
            clearmap()
            drawMap(store.mapafterlinelasso)
  
          clearbar()
          drawbar(a)
  
      //      drawCircles(store.done,"red")
      //  drawCirclesRecovered(store.done,"red")
      //  drawCirclesdeath(store.done,"red")
  
  
      rehiglight()
  
  
       recalibrate()
          
          
         
     }
  
     function rehiglight()
     {
  
  
  
      // let l= d3.selectAll("rect")._groups[0]
      //   let ln=d3.selectAll("rect")._groups[0].length-6
      //  for(i=0;i<ln;i++)
      //  {
        
        
      //    if(store.currentselectedcountries.includes(l[i].__data__.country) || store.currentselectedcountries.includes(l[i].__data__.country.toLowerCase()))
      //    {
           
          
      //      d3.select(l[i]).classed("selected",true)
          
  
      //    }
      //    else{
      //      d3.select(l[i]).classed("selected",false)
      //    }
      //  }
  
     }
    
  
    function recalibrate()
    {
  //     let a=[]
  //     let b=[]
  //     let c=[]
  //     for(let i=0;i<store.afterlasso.length;i++)
  //     {
  //       a.push(store.afterlasso[i].country)
  //     }
  //     store.afterlasso=[]
  //      l= d3.selectAll("rect")._groups[0]
  //         ln=d3.selectAll("rect")._groups[0].length-6
  //         for(i=0;i<ln;i++)
  //      {
  //        if(a.includes(l[i].__data__.country)){
  //         b.push(l[i].__data__);
  //        }
  //        c.push(l[i].__data__)
  //        if(b.length!=0)store.afterlasso=b;
  //        else store.afterlasso=c;
         
  //      }
  //      if(store.afterlasso.length!=207)
  //      {
  //       var uniqueNames = [];
  // $.each(store.afterlasso, function(i, el){
  //     if($.inArray(el, uniqueNames) === -1) uniqueNames.push(el);
  // });
  //   store.afterlasso=uniqueNames
  //      }
  a=0
       
    }
  
  
    function clearmap()
    {
      d3.select("#G").remove()
            d3.select("#Map").append("g").attr("id","G")
    }
     //end after lasso
     // after bar lasso
  
      function afterbarlasso(data){
        console.log("asci")
        var pdata = []
        var finald = []
        let i = 0;
        for(x of data ){
          for (d of store.time){
            
                if(x.__data__.region == d.key){
                  pdata[i] = d.values;
                  break;
                }
           }
        
           ++i;
      }
      i=0;
        //console.log(pdata)
        for( x of pdata[0]){
          finald[i] = {
              "confirmed" : x.confirmed,
              "recovered" : x.recovered,
              "deaths" : x.deaths,
              "active" : x.active,
              "date" :   x.date ,
              "new_case" : x.new,
              "new_death_case" : x.new_death,
              "new_recovered_case" : x.new_recovered,
              "new_active_case" : x.new_active
          }
          ++i;
        }

        //console.log(finald)
  
        for( var k =1; k< pdata.length; ++k){
          let j=0;
          for( x of pdata[k]){
            finald[j].confirmed += x.confirmed;
            finald[j].recovered += x.recovered;
            finald[j].deaths += x.deaths
            finald[j].active += x.active;
            finald[j].new_case +=x.new_case;
            finald[j].new_death_case +=x.new_death_case;
            finald[j].new_recovered_case +=x.new_recovered_case;
            finald[j].new_active_case += x.new_active_case;
            ++j;
          }
        }

        console.log(finald)
        
        drawline(finald)
      }
  
  
      function aftermaplasso(data){
        var pdata = []
        var finald = []
        let i = 0;
        for(x of data ){
          for (d of store.time){
            
                if(x.properties.STATE_NAME == d.key){
                  pdata[i] = d.values;
                  break;
                }
           }
        
           ++i;
      }
      i=0;
        //console.log(pdata)
        for( x of pdata[0]){
          finald[i] = {
              "confirmed" : x.confirmed,
              "recovered" : x.recovered,
              "deaths" : x.deaths,
              "date" :   x.date,
              "new_case" : x.new,
              "new_death_case" : x.new_death,
              "new_recovered_case" : x.new_recovered,
              "new_active_case" : x.new_active
          }
          ++i;
        }
  
        for( var k =1; k< pdata.length; ++k){
          let j=0;
          for( x of pdata[k]){
            finald[j].confirmed += x.confirmed;
            finald[j].recovered += x.recovered;
            finald[j].deaths += x.deaths;
            finald[j].active += x.active;
            finald[j].new_case +=x.new_case;
            finald[j].new_death_case +=x.new_death_case;
            finald[j].new_recovered_case +=x.new_recovered_case;
            finald[j].new_active_case += x.new_active_case;
            ++j;
          }
        }
        drawline(finald)
      }
  
     //end bar lasso
        
  // clear bar
  
     function clearbar(){
      document.getElementById("BarChart").innerHTML="";
     }
  
     function commandline(a)
     {
      var pdata = []
        var finald = []
        
      
          for(i of store.time)
          {
            if(a.includes(i.key.toLowerCase()))
            {
              pdata.push(i.values)
            }
            
          }
  
    
      i=0;
        console.log(pdata)
        for( x of pdata[0]){
          finald[i] = {
              "confirmed" : x.confirmed,
              "recovered" : x.recovered,
              "deaths" : x.deaths,
              "date" :   x.date 
          }
          ++i;
        }
  
        for( var k =1; k< pdata.length; ++k){
          let j=0;
          for( x of pdata[k]){
            finald[j].confirmed += x.confirmed;
            finald[j].recovered += x.recovered;
            finald[j].deaths += x.deaths
            ++j;
          }
        }
        return finald;
     }
  
  //end

  // stack bar

  function drawstackbar(data){
    console.log(data)
  var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 660 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;
 
var x0 = d3.scaleBand().range([0, width]);
 
var x1 = d3.scaleBand().padding(.14);
 
var y = d3.scaleLinear()
    .range([height, 0]);
 
var xAxis = d3.axisBottom()
    .scale(x0);
 
var yAxis = d3.axisLeft()
    .scale(y)
    .tickFormat(d3.format(".2s"));
 
var color = d3.scaleOrdinal().range(
    ["orange", "#cb181d", "#238b45"]);
 
var svg = d3.select("#stack").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
 
var yBegin;
 
var innerColumns = {
  "column1" : ["active", "deaths", "recovered"]
}
 
  var columnHeaders = ["active", "deaths", "recovered"];
  //console.log(columnHeaders)
  color.domain(["active", "deaths", "recovered"]);
  data.forEach(function(d) {
    var yColumn = new Array();
    d.columnDetails = columnHeaders.map(function(name) {
      for (ic in innerColumns) {
        if($.inArray(name, innerColumns[ic]) >= 0){
          if (!yColumn[ic]){
            yColumn[ic] = 0;
          }
          yBegin = yColumn[ic];
          yColumn[ic] += +d[name];
          return {name: name, column: ic, yBegin: yBegin, yEnd: +d[name] + yBegin,};
        }
      }
    });//console.log(d.columnDetails)
    d.total = d3.max(d.columnDetails, function(d) { 
      return d.yEnd; 
    });
  });
 
  x0.domain(data.map(function(d) { return d.region; }));
  x1.domain(d3.keys(innerColumns)).range([0, x0.bandwidth()]);
 
  y.domain([0, d3.max(data, function(d) { 
    return d.total; 
  })]);
 
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);
 
  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".7em")
      .style("text-anchor", "end")
      .text("");
 
  var project_stackedbar = svg.selectAll(".project_stackedbar")
      .data(data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + x0(d.region) + ",0)"; });
 
  project_stackedbar.selectAll("rect")
      .data(function(d) { return d.columnDetails; })
    .enter().append("rect")
      .attr("width", x1.bandwidth())
      .attr("x", function(d) { 
        return x1(d.column);
         })
      .attr("y", function(d) { 
        return y(d.yEnd); 
      })
      .attr("height", function(d) { 
        return y(d.yBegin) - y(d.yEnd); 
      })
      .style("fill", function(d) {
          return color(d.name);
      })
      .on("click", d=>{
		    	console.log(d)
		    });
 
  var legend = svg.selectAll(".legend")
      .data(columnHeaders.slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
 
  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);
 
  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });
 

}
  //end bar

        </script>
    </html>